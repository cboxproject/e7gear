<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.4/dist/tesseract.min.js'></script>
    <script>
        const subOpNameIndex = 0;
        const subOpValueIndex = 0;
        const mainOpNameIndex = 1;
        const mainOpValueIndex = 1;
        const setIndex = 2;
        const enhanceIndex = 2;
        const levelIndex = 3;
        const rareIndex = 3;

        const rectList = [
            { top: 420, left: 30, width: 270, height: 155, threshold: 80, zoom: 2, lng: "jpn" },    //サブop名4種
            { top: 420, left: 300, width: 115, height: 155, threshold: 80, zoom: 2, lng: "eng" },   //サブop数値4種
            { top: 350, left: 85, width: 220, height: 80, threshold: 80, zoom: 2, lng: "jpn" },     //メインop名
            { top: 350, left: 305, width: 110, height: 80, threshold: 80, zoom: 2, lng: "eng" },    //メインop数値
            { top: 575, left: 100, width: 315, height: 65, threshold: 80, zoom: 2, lng: "jpn" },    //セット
            { top: 170, left: 143, width: 26, height: 50, threshold: 140, zoom: 2, lng: "eng" },     //強化
            { top: 185, left: 65, width: 24, height: 46, threshold: 90, zoom: 2, lng: "eng" },      //レベル
            { top: 190, left: 180, width: 235, height: 65, threshold: 20, zoom: 2, lng: "jpn" },    //レア度
        ];

        const opNameList = [
            { match: "攻", langJp: "攻撃力", langEng: "Attack" },
            { match: "防", langJp: "防御力", langEng: "Defense" },
            { match: "生命", langJp: "生命力", langEng: "Health" },
            { match: "スピ", langJp: "スピード", langEng: "Speed" },
            { match: "発生", langJp: "クリティカル発生率", langEng: "CriticalHitChancePercent" },
            { match: "ダメ", langJp: "クリティカルダメージ", langEng: "CriticalHitDamagePercent" },
            { match: "命中", langJp: "効果命中率", langEng: "EffectivenessPercent" },
            { match: "抵抗", langJp: "効果低効率", langEng: "EffectResistancePercent" },
        ];

        const setNameList = [
            { match: "攻", langJp: "攻撃", langEng: "AttackSet" },
            { match: "防", langJp: "防御", langEng: "DefenseSet" },
            { match: "生命", langJp: "生命", langEng: "HealthSet" },
            { match: "速度", langJp: "速度", langEng: "SpeedSet" },
            { match: "会心", langJp: "会心", langEng: "CriticalSet" },
            { match: "破", langJp: "破滅", langEng: "DestructionSet" },
            { match: "命中", langJp: "命中", langEng: "HitSet" },
            { match: "抵抗", langJp: "抵抗", langEng: "ResistSet" },
            { match: "吸収", langJp: "吸収", langEng: "LifestealSet" },
            { match: "反", langJp: "反撃", langEng: "CounterSet" },
            { match: "連", langJp: "連携", langEng: "UnitySet" },
            { match: "免疫", langJp: "免疫", langEng: "ImmunitySet" },
            { match: "憤怒", langJp: "憤怒", langEng: "RageSetSet" },
            { match: "貫通", langJp: "貫通", langEng: "PenetrationSet" },
            { match: "復讐", langJp: "復讐", langEng: "RevengeSet" },
            { match: "裂傷", langJp: "裂傷", langEng: "InjurySet" },
        ];

        const rareList = [
            { match: "エピ", langJp: "エピック", langEng: "Epic" },
            { match: "レジ", langJp: "レジェンド", langEng: "Heroic" },
            { match: "レア", langJp: "レア", langEng: "Rare" },
            { match: "ユニ", langJp: "ユニーク", langEng: "Good" },
            { match: "マル", langJp: "ノーマル", langEng: "Normal" },
        ];

        const partsList = [
            { match: "武器", langJp: "武器", langEng: "Weapon" },
            { match: "頭", langJp: "頭", langEng: "Helmet" },
            { match: "胴", langJp: "胴", langEng: "Armor" },
            { match: "首", langJp: "首", langEng: "Necklace" },
            { match: "指", langJp: "指", langEng: "Ring" },
            { match: "脚", langJp: "脚", langEng: "Boots" },
        ];

        let isCsv = false;

        function loadFile(file){
            return new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = () => resolve(reader);
                reader.readAsDataURL(file);
            });
        }

        function loadImage(file){
            return new Promise(async(resolve, reject) => {
                let reader = await loadFile(file);
                var image = new Image();
                image.onload = () => resolve(image);
                image.src = reader.result;
            });
        }

        function deleteCanvas(){
            $(".tmp_canvas").remove();
        }

        async function writeCanvas(file){
            const padding = 20;
            deleteCanvas();
            let image = await loadImage(file);

            for(let i = 0; i < rectList.length; i++){
                let canvas = document.createElement("canvas");
                document.body.appendChild(canvas);
                canvas.width = rectList[i].width * rectList[i].zoom;
                canvas.height = rectList[i].height * rectList[i].zoom;
                canvas.className = "tmp_canvas " + rectList[i].lng;
                let ctx = canvas.getContext("2d");
                ctx.scale(rectList[i].zoom, rectList[i].zoom);
                ctx.drawImage(image, -rectList[i].left, -rectList[i].top);

                let imageData = ctx.getImageData(0, 0, canvas.clientWidth, canvas.clientHeight);
                if (rectList[i].threshold >= 0){
                    imageData = filterThreshold(imageData, rectList[i].threshold);
                }

                imageData = filterReverse(imageData);

                canvas.width += padding;
                canvas.height += padding;
                ctx.putImageData(imageData, padding / 2, padding / 2);
            }
        }

        function changeFile(){
            //チェック用1件のみ表示
            let files = document.getElementById("gear_file").files;
            if (files.length > 0){
                (async () => {
                    await writeCanvas(files[0]);
                })();
            }
        }

        //二極化
        function filterThreshold(imageData, threshold){
            let data = imageData.data;
            for(let i = 0; i < data.length; i += 4){
                let tmp = 0;
                if (threshold < ((data[i] + data[i+1] + data[i+2]) / 3))
                    tmp = 255;
                data[i] = data[i + 1] = data[i + 2] = tmp;
            }
            return imageData;
        }

        //反転
        function filterReverse(imageData){
            let data = imageData.data;
            for(let i = 0; i < data.length; i += 4){
                data[i] = 255 - data[i];
                data[i + 1] = 255 - data[i + 1];
                data[i + 2] = 255 - data[i + 2];
            }
            return imageData;
        }

        function createWorker(lng){
            return new Promise(async(resolve, reject) => {
                const worker = Tesseract.createWorker();
                await worker.load();
                await worker.loadLanguage(lng);
                await worker.initialize(lng);
                if (lng == "eng")
                    await worker.setParameters({tessedit_char_whitelist: "0123456789%+"});
                else
                    await worker.setParameters({tessedit_char_whitelist: "連携攻撃力生命スピード効果抵抗率中防御速度のセットクリティカルダメジ発会心復讐破滅吸収免疫反裂傷貫通ノマレェンアエ武器頭具胴首飾り指輪脚ユニ"});
                resolve(worker);
            });
        }

        function csvDownload(gearList){
            var data = "";
            for (let i = 0; i < gearList.length; i++){
                data +=
                    gearList[i].fileName
                    + "," + gearList[i].level
                    + "," + gearList[i].rare
                    + "," + gearList[i].parts
                    + "," + gearList[i].enhance
                    + "," + gearList[i].setName
                    + "," + gearList[i].mainOpName
                    + "," + gearList[i].mainOpValue
                    + "," + gearList[i].sub1OpName
                    + "," + gearList[i].sub1OpValue
                    + "," + gearList[i].sub2OpName
                    + "," + gearList[i].sub2OpValue
                    + "," + gearList[i].sub3OpName
                    + "," + gearList[i].sub3OpValue
                    + "," + gearList[i].sub4OpName
                    + "," + gearList[i].sub4OpValue
                    + "\n"
            }
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, data], {"type": "text/csv"});
            const download = document.createElement("a");
            const url = window.URL.createObjectURL(blob);
            download.href = url;
            download.download = "geardata.csv";
            download.click();
            window.URL.revokeObjectURL(url);
        }

        function parseE7OptOption(name, value){
            if (name == "")
                return "";
            if (value.indexOf("%") >= 0){
                value = value.replace("%", "");
                name += "Percent";
            }
            return '{"type":"' + name + '","value":' + value + '}';
        }

        function e7OptDownload(gearList){
            let dataList = new Array();
            for (let i = 0; i < gearList.length; i++){
                let subList = new Array();
                subList.push(parseE7OptOption(gearList[i].sub1OpName, gearList[i].sub1OpValue));
                subList.push(parseE7OptOption(gearList[i].sub2OpName, gearList[i].sub2OpValue));
                subList.push(parseE7OptOption(gearList[i].sub3OpName, gearList[i].sub3OpValue));
                subList.push(parseE7OptOption(gearList[i].sub4OpName, gearList[i].sub4OpValue));
                dataList.push(
                    "{"
                    + '"gear":"' + gearList[i].parts + '",'
                    + '"rank":"' + gearList[i].rare + '",'
                    + '"set":"' + gearList[i].setName + '",'
                    + '"level":' + gearList[i].level + ','
                    + '"enhance":' + gearList[i].enhance + ','
                    + '"main":' + parseE7OptOption(gearList[i].mainOpName, gearList[i].mainOpValue) + ','
                    + '"substats":[' + subList.filter(x => x != "").join(',') + '],'
                    + '"name":"unknown",'
                    + '"heroName":null'
                    + "}");
            }
            const data = '{"items":[' + dataList.join(',') + ']}';
            const blob = new Blob([data], {"type": "text/plain"});
            const download = document.createElement("a");
            const url = window.URL.createObjectURL(blob);
            download.href = url;
            download.download = "geardatae7opt.txt";
            download.click();
            window.URL.revokeObjectURL(url);
        }

        function parseText(value, isFirst = false){
            //最初のみ抽出
            if (isFirst)
                value = value.split('\n')[0];
            return value.replaceAll(/[ \n]/ig,"");
        }

        //数値系
        function parseValue(value, max = -1, isFirst = false){
            value = parseText(value, isFirst);
            let result = value.match(/[0-9%]+/gi);
            let resultValue = result ? result[0] : "0";
            if (max != -1)
                resultValue = parseInt(resultValue) > max ? "0" : resultValue;
            return resultValue;
        }

        //リスト一致
        function parseList(value, list){
            value = parseText(value);
            let m = list.find(x => value.indexOf(x.match) >= 0);
            if (m)
                if (isCsv)
                    return m.langJp;
                else
                    return m.langEng;
            else
                return "";
        }

        //サブオプション名用
        function parseSubName(value, index, list){
            let sp = value.split(/\n+/ig);
            if (sp.length > index)
                return parseList(sp[index], list);
            else
                return "";
        }

        //サブオプション数値用
        function parseSubValue(value, index){
            let sp = value.split(/\n+/ig);
            if (sp.length > index)
                return parseValue(sp[index]);
            else
                return "0";
        }

        function readGear(){
            $("#read_button").prop("disabled", true);
            isCsv = $("input[name=download_type]:checked").val() == "csv";
            let files = document.getElementById("gear_file").files;
            let gearList = new Array();

            (async () => {
                console.log(Date.now());
                $("#status_field").text("準備中..");
                const schedulerJp = Tesseract.createScheduler();
                const schedulerEng = Tesseract.createScheduler();
                schedulerJp.addWorker(await createWorker('jpn'));
                schedulerJp.addWorker(await createWorker('jpn'));
                schedulerEng.addWorker(await createWorker('eng'));
                schedulerEng.addWorker(await createWorker('eng'));
                console.log(Date.now());

                for (var i = 0; i < files.length; i++){
                    $("#status_field").text("ファイル解析中(" + (i + 1) + "/" + files.length + ")");
                    await writeCanvas(files[i]);

                    const resultsJp = await Promise.all(Array.from($(".tmp_canvas.jpn")).map((canvas) => (
                        schedulerJp.addJob('recognize', canvas)
                    )));
                    const resultsEng = await Promise.all(Array.from($(".tmp_canvas.eng")).map((canvas) => (
                        schedulerEng.addJob('recognize', canvas)
                    )));
                    var rowDataJp = resultsJp.map(({ data: { text } }) => text);
                    var rowDataEng = resultsEng.map(({ data: { text } }) => text);
                    var gearData = {
                        fileName: files[i].name,
                        rare: parseList(rowDataJp[rareIndex], rareList),
                        parts: parseList(rowDataJp[rareIndex], partsList),
                        enhance: parseValue(rowDataEng[enhanceIndex], 15),
                        level: parseValue(rowDataEng[levelIndex], -1, true),
                        setName: parseList(rowDataJp[setIndex], setNameList),
                        mainOpName: parseList(rowDataJp[mainOpNameIndex], opNameList),
                        mainOpValue: parseValue(rowDataEng[mainOpValueIndex]),
                        sub1OpName: parseSubName(rowDataJp[subOpNameIndex], 0, opNameList),
                        sub2OpName: parseSubName(rowDataJp[subOpNameIndex], 1, opNameList),
                        sub3OpName: parseSubName(rowDataJp[subOpNameIndex], 2, opNameList),
                        sub4OpName: parseSubName(rowDataJp[subOpNameIndex], 3, opNameList),
                        sub1OpValue: parseSubValue(rowDataEng[subOpValueIndex], 0),
                        sub2OpValue: parseSubValue(rowDataEng[subOpValueIndex], 1),
                        sub3OpValue: parseSubValue(rowDataEng[subOpValueIndex], 2),
                        sub4OpValue: parseSubValue(rowDataEng[subOpValueIndex], 3),
                    };
                    console.log(rowDataJp);
                    console.log(rowDataEng);
                    gearList.push(gearData);
                }
                console.log(gearList);
                deleteCanvas();
                if (isCsv)
                    csvDownload(gearList);
                else
                    e7OptDownload(gearList);

                $("#status_field").text("終了");
                console.log(Date.now());

                await schedulerJp.terminate();
                await schedulerEng.terminate();
                $("#read_button").prop("disabled", false);
            })();
        }
    </script>
    <style>
        canvas{ padding: 10px }
    </style>
</head>
<body>
<div>
    <div id="config_field">
        <input id="gear_file" type="file" multiple="multiple" onchange="changeFile()">
        <button id="read_button" onclick="readGear()">ギア読み込み</button>
        <input type="radio" name="download_type" value="e7opt" checked="checked">Optimizer用
        <input type="radio" name="download_type" value="csv">csv
    </div>
    <div id="status_field"></div>
    <div id="error_field"></div>
</div>
</body>
</html>